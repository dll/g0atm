pipeline {
    agent any
       stages{
        stage('SonarQue Analysis') {
            steps {
                withSonarQubeEnv('SonarQube'){
                    bat '''
                         sonar-scanner.bat -D"sonar.projectKey=g0atm" -D"sonar.sources=."
                         -D"sonar.host.url=http://localhost:9000"
                         -D"sonar.login=sqp_ac0691d3c4c4916ce61f39dc54f4e311781545c5"
                        '''
               }
            }
        }
        stage('Quality Gate') {
            steps {
                script{
                    sleep(10)
                    timeout(time: 5, unit: 'MINUTES'){
                        //waitForQualityGate abortPipeline:true
                        def qg = waitForQualityGate()
                        if (qg.status != 'OK') {
                            error "Pipeline aborted due to quality gate failure: ${qg.status}"
                        }
                    }
                }
            }
        }
        stage('Build') {
            steps {
                bat 'python -m py_compile g0atm0/Customer.py g0atm0/DbUtil.py'
            }
        }
        stage('UnitTest') {
            steps {
		        bat 'py.test --verbose --junit-xml test-reports/results.xml g0atm0/test_customer.py g0atm0/test_dbutil.py'
            }
            post {
               always {
                   junit 'test-reports/results.xml'
               }
            }
        }
        stage('IntergrateTest') {
            steps{
                bat 'python -m py_compile g0atm0/intergrateTest.py'
            }

        }
        stage('Deliver') {
            steps {
                bat 'pyinstaller -F g0atm0/Customer.py -n login_atm.exe'
            }
            post {
                success {
                    archiveArtifacts 'dist/login_atm.exe'
                }
            }
        }
        stage('Deploy Gitee'){
            steps{
                echo 'release gitee'
            }
        }
        stage('Execute login_atm.exe'){
            steps{
               bat 'dist/login_atm.exe'
            }
        }
    }
}